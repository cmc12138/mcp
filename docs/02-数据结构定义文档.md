# 数据结构定义文档

## 1. 概述

本文档定义了前端逻辑转AI理解MCP项目中使用的所有数据结构。这些结构用于表示前端代码的各种元素，确保AI能够准确理解代码逻辑。

## 2. 核心数据结构

### 2.1 项目级别结构

#### 2.1.1 ProjectInfo
项目整体信息结构，包含项目的基本信息和所有文件信息。

```typescript
interface ProjectInfo {
  name: string;                    // 项目名称
  framework: string;               // 框架类型 (react, vue, angular, vanilla)
  files: FileInfo[];              // 文件列表
  dependencies: DependencyInfo[]; // 依赖信息
}
```

**字段说明**:
- `name`: 项目名称，通常从package.json或目录名获取
- `framework`: 前端框架类型，通过分析package.json中的依赖确定
- `files`: 项目中所有源代码文件的信息数组
- `dependencies`: 项目依赖包的信息数组

#### 2.1.2 DependencyInfo
项目依赖信息结构。

```typescript
interface DependencyInfo {
  name: string;                    // 依赖包名
  version: string;                 // 版本号
  type: 'dependency' | 'devDependency' | 'peerDependency'; // 依赖类型
  usedIn: string[];               // 使用该依赖的文件列表
}
```

**字段说明**:
- `name`: 依赖包的名称
- `version`: 依赖包的版本号
- `type`: 依赖类型，区分生产依赖、开发依赖和同级依赖
- `usedIn`: 使用该依赖的文件路径列表

### 2.2 文件级别结构

#### 2.2.1 FileInfo
单个文件的信息结构。

```typescript
interface FileInfo {
  path: string;                    // 文件路径
  type: 'component' | 'page' | 'util' | 'service' | 'store'; // 文件类型
  variables: VariableInfo[];      // 变量列表
  functions: FunctionInfo[];      // 函数列表
  components: ComponentInfo[];    // 组件列表
}
```

**字段说明**:
- `path`: 文件的完整路径
- `type`: 文件类型，根据文件名和内容推断
- `variables`: 文件中定义的所有变量
- `functions`: 文件中定义的所有函数
- `components`: 文件中定义的所有组件

**文件类型判断规则**:
- `component`: 文件名包含"component"或"Component"
- `page`: 文件名包含"page"或"Page"
- `service`: 文件名包含"service"或"Service"
- `store`: 文件名包含"store"或"Store"
- `util`: 其他类型的文件

### 2.3 变量级别结构

#### 2.3.1 VariableInfo
变量详细信息结构。

```typescript
interface VariableInfo {
  name: string;                    // 变量名
  type: string;                    // 变量类型
  scope: 'global' | 'module' | 'function' | 'block'; // 作用域
  declarationType: 'var' | 'let' | 'const' | 'function' | 'class'; // 声明类型
  usage: VariableUsage[];         // 使用情况列表
  dependencies: string[];         // 依赖的变量列表
  description?: string;           // 变量描述（可选）
  isExported: boolean;            // 是否被导出
  isImported: boolean;            // 是否被导入
  line: number;                   // 声明行号
  column: number;                 // 声明列号
}
```

**字段说明**:
- `name`: 变量的名称
- `type`: 变量的类型，通过类型推断获得
- `scope`: 变量的作用域
- `declarationType`: 变量的声明方式
- `usage`: 变量的使用情况列表
- `dependencies`: 该变量依赖的其他变量
- `description`: 变量的描述信息（如果有注释）
- `isExported`: 变量是否被导出
- `isImported`: 变量是否被导入
- `line`: 变量声明的行号
- `column`: 变量声明的列号

#### 2.3.2 VariableUsage
变量使用情况结构。

```typescript
interface VariableUsage {
  type: 'assignment' | 'reference' | 'parameter' | 'return'; // 使用类型
  location: SourceLocation;       // 使用位置
  context: string;                // 使用上下文
}
```

**字段说明**:
- `type`: 使用类型
  - `assignment`: 赋值使用
  - `reference`: 引用使用
  - `parameter`: 作为参数使用
  - `return`: 作为返回值使用
- `location`: 使用位置信息
- `context`: 使用的上下文代码片段

#### 2.3.3 SourceLocation
源代码位置信息。

```typescript
interface SourceLocation {
  line: number;                   // 行号
  column: number;                 // 列号
  file: string;                   // 文件路径
}
```

### 2.4 函数级别结构

#### 2.4.1 FunctionInfo
函数详细信息结构。

```typescript
interface FunctionInfo {
  name: string;                   // 函数名
  type: 'function' | 'arrow' | 'method' | 'constructor'; // 函数类型
  parameters: ParameterInfo[];    // 参数列表
  returnType: string;             // 返回类型
  calls: FunctionCall[];          // 调用的函数列表
  calledBy: string[];             // 被哪些函数调用
  complexity: number;             // 复杂度
  line: number;                   // 定义行号
  column: number;                 // 定义列号
}
```

**字段说明**:
- `name`: 函数的名称
- `type`: 函数类型
  - `function`: 普通函数声明
  - `arrow`: 箭头函数
  - `method`: 类方法
  - `constructor`: 构造函数
- `parameters`: 函数参数列表
- `returnType`: 函数返回类型
- `calls`: 函数内部调用的其他函数
- `calledBy`: 调用该函数的其他函数
- `complexity`: 函数的圈复杂度
- `line`: 函数定义的行号
- `column`: 函数定义的列号

#### 2.4.2 ParameterInfo
函数参数信息结构。

```typescript
interface ParameterInfo {
  name: string;                   // 参数名
  type: string;                   // 参数类型
  defaultValue?: any;             // 默认值
  isOptional: boolean;            // 是否可选
  description?: string;           // 参数描述
}
```

#### 2.4.3 FunctionCall
函数调用信息结构。

```typescript
interface FunctionCall {
  name: string;                   // 被调用的函数名
  location: SourceLocation;       // 调用位置
  arguments: any[];               // 调用参数
}
```

### 2.5 组件级别结构

#### 2.5.1 ComponentInfo
组件详细信息结构。

```typescript
interface ComponentInfo {
  name: string;                   // 组件名
  type: 'functional' | 'class' | 'sfc'; // 组件类型
  props: PropInfo[];              // 属性列表
  state: StateInfo[];             // 状态列表
  hooks: HookInfo[];              // Hook列表
  line: number;                   // 定义行号
  column: number;                 // 定义列号
}
```

**字段说明**:
- `name`: 组件的名称
- `type`: 组件类型
  - `functional`: 函数组件
  - `class`: 类组件
  - `sfc`: 单文件组件（Vue）
- `props`: 组件的属性列表
- `state`: 组件的状态列表
- `hooks`: 组件使用的Hook列表
- `line`: 组件定义的行号
- `column`: 组件定义的列号

#### 2.5.2 PropInfo
组件属性信息结构。

```typescript
interface PropInfo {
  name: string;                   // 属性名
  type: string;                   // 属性类型
  required: boolean;              // 是否必需
  defaultValue?: any;             // 默认值
  description?: string;           // 属性描述
}
```

#### 2.5.3 StateInfo
组件状态信息结构。

```typescript
interface StateInfo {
  name: string;                   // 状态名
  type: string;                   // 状态类型
  initialValue?: any;             // 初始值
  setter?: string;                // 设置函数名
}
```

#### 2.5.4 HookInfo
React Hook信息结构。

```typescript
interface HookInfo {
  name: string;                   // Hook名称
  type: string;                   // Hook类型
  dependencies: string[];         // 依赖列表
  line: number;                   // 使用行号
  column: number;                 // 使用列号
}
```

## 3. 类型推断规则

### 3.1 基础类型推断

```typescript
// 字面量类型推断
string literal → 'string'
number literal → 'number'
boolean literal → 'boolean'
array expression → 'array'
object expression → 'object'
function expression → 'function'
class expression → 'class'
```

### 3.2 复杂类型推断

```typescript
// 复杂类型推断规则
null/undefined → 'any'
identifier → 查找声明类型
call expression → 分析返回值类型
member expression → 分析成员类型
```

### 3.3 作用域分析规则

```typescript
// 作用域判断规则
global scope → 在程序顶层声明
module scope → 在模块顶层声明
function scope → 在函数内声明
block scope → 在块语句内声明
```

## 4. 数据验证规则

### 4.1 必填字段验证

```typescript
// 所有接口的必填字段
ProjectInfo: ['name', 'framework', 'files', 'dependencies']
FileInfo: ['path', 'type', 'variables', 'functions', 'components']
VariableInfo: ['name', 'type', 'scope', 'declarationType', 'usage', 'dependencies', 'isExported', 'isImported', 'line', 'column']
FunctionInfo: ['name', 'type', 'parameters', 'returnType', 'calls', 'calledBy', 'complexity', 'line', 'column']
ComponentInfo: ['name', 'type', 'props', 'state', 'hooks', 'line', 'column']
```

### 4.2 类型约束验证

```typescript
// 枚举值验证
framework: ['react', 'vue', 'angular', 'vanilla']
fileType: ['component', 'page', 'util', 'service', 'store']
variableScope: ['global', 'module', 'function', 'block']
declarationType: ['var', 'let', 'const', 'function', 'class']
functionType: ['function', 'arrow', 'method', 'constructor']
componentType: ['functional', 'class', 'sfc']
usageType: ['assignment', 'reference', 'parameter', 'return']
```

### 4.3 数值范围验证

```typescript
// 数值范围约束
line: >= 1
column: >= 0
complexity: >= 1
```

## 5. 数据序列化格式

### 5.1 JSON序列化

所有数据结构都支持JSON序列化，用于MCP协议传输。

```typescript
// 序列化示例
const projectInfo: ProjectInfo = { ... };
const jsonString = JSON.stringify(projectInfo, null, 2);
```

### 5.2 压缩格式

对于大型项目，支持压缩格式以减少传输大小。

```typescript
// 压缩序列化
const compressed = gzip(JSON.stringify(projectInfo));
```

## 6. 扩展性考虑

### 6.1 向后兼容

- 新增字段使用可选属性
- 保持现有字段不变
- 提供默认值处理

### 6.2 版本控制

```typescript
interface VersionedData {
  version: string;                // 数据版本
  data: ProjectInfo;             // 实际数据
}
```

### 6.3 元数据支持

```typescript
interface Metadata {
  createdAt: string;             // 创建时间
  updatedAt: string;             // 更新时间
  analyzerVersion: string;       // 分析器版本
  projectHash: string;           // 项目哈希
}
```

## 7. 性能优化

### 7.1 懒加载

对于大型项目，支持按需加载文件信息。

```typescript
interface LazyFileInfo extends FileInfo {
  loaded: boolean;               // 是否已加载
  loadPromise?: Promise<void>;   // 加载Promise
}
```

### 7.2 增量更新

支持增量更新，只更新变更的部分。

```typescript
interface IncrementalUpdate {
  type: 'add' | 'update' | 'remove';
  path: string;
  data?: any;
}
```

## 8. 错误处理

### 8.1 数据验证错误

```typescript
interface ValidationError {
  field: string;                 // 错误字段
  message: string;               // 错误信息
  value: any;                    // 错误值
}
```

### 8.2 分析错误

```typescript
interface AnalysisError {
  file: string;                  // 错误文件
  line: number;                  // 错误行号
  message: string;               // 错误信息
  type: 'parse' | 'analyze' | 'validate'; // 错误类型
}
```

---

**文档版本**: v1.0  
**创建日期**: 2024年12月  
**最后更新**: 2024年12月  
**维护者**: AI助手
