# 开发指南文档

## 1. 概述

本文档为前端逻辑转AI理解MCP项目的开发者提供详细的开发指南，包括开发环境搭建、代码规范、测试策略、部署流程等。

## 2. 开发环境搭建

### 2.1 环境要求

- **Node.js**: >= 18.0.0
- **npm**: >= 8.0.0
- **TypeScript**: >= 5.2.0
- **Git**: >= 2.30.0

### 2.2 开发工具推荐

- **IDE**: VS Code
- **插件**: TypeScript, ESLint, Prettier, GitLens
- **调试**: Node.js Debugger
- **测试**: Jest, Supertest

### 2.3 项目初始化

```bash
# 克隆项目
git clone https://github.com/your-username/frontend-analysis-mcp.git
cd frontend-analysis-mcp

# 安装依赖
npm install

# 安装开发依赖
npm install --save-dev @types/node @types/jest

# 初始化Git hooks
npm run prepare
```

### 2.4 开发脚本

```json
{
  "scripts": {
    "dev": "tsx mcp-server-example.ts",
    "build": "tsc",
    "start": "node dist/mcp-server-example.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "lint": "eslint . --ext .ts,.tsx",
    "lint:fix": "eslint . --ext .ts,.tsx --fix",
    "format": "prettier --write .",
    "type-check": "tsc --noEmit"
  }
}
```

## 3. 代码规范

### 3.1 TypeScript规范

#### 3.1.1 类型定义

```typescript
// 使用接口定义对象结构
interface ProjectInfo {
  name: string;
  framework: string;
  files: FileInfo[];
  dependencies: DependencyInfo[];
}

// 使用类型别名定义联合类型
type FileType = 'component' | 'page' | 'util' | 'service' | 'store';

// 使用枚举定义常量
enum ErrorCode {
  PARSE_ERROR = 'PARSE_ERROR',
  ANALYSIS_ERROR = 'ANALYSIS_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
}
```

#### 3.1.2 函数定义

```typescript
// 使用明确的参数和返回类型
async function analyzeProject(projectPath: string): Promise<ProjectInfo> {
  // 实现
}

// 使用可选参数
function createVariableInfo(
  name: string,
  type: string,
  options?: {
    scope?: VariableScope;
    isExported?: boolean;
  }
): VariableInfo {
  // 实现
}
```

#### 3.1.3 类定义

```typescript
// 使用访问修饰符
class FrontendCodeAnalyzer {
  private projectPath: string;
  private projectInfo: ProjectInfo;

  constructor(projectPath: string) {
    this.projectPath = projectPath;
    this.projectInfo = this.createDefaultProjectInfo();
  }

  public async analyzeProject(): Promise<ProjectInfo> {
    // 公共方法
  }

  private detectFramework(): void {
    // 私有方法
  }
}
```

### 3.2 命名规范

#### 3.2.1 变量命名

```typescript
// 使用camelCase
const projectPath = '/path/to/project';
const fileInfo = await analyzeFile(filePath);

// 常量使用UPPER_SNAKE_CASE
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
const SUPPORTED_EXTENSIONS = ['.js', '.jsx', '.ts', '.tsx', '.vue'];
```

#### 3.2.2 函数命名

```typescript
// 使用动词开头
function analyzeProject(): Promise<ProjectInfo> {}
function extractVariableInfo(): VariableInfo | null {}
function generateFlowDiagram(): string {}

// 布尔函数使用is/has/can开头
function isReactComponent(): boolean {}
function hasJSXReturn(): boolean {}
function canParseFile(): boolean {}
```

#### 3.2.3 类命名

```typescript
// 使用PascalCase
class FrontendCodeAnalyzer {}
class MCPServer {}
class VariableTracker {}
```

### 3.3 注释规范

#### 3.3.1 文件头注释

```typescript
/**
 * 前端逻辑转AI理解MCP服务器实现示例
 * 基于Model Context Protocol的前端代码分析工具
 *
 * @author AI Assistant
 * @version 1.0.0
 * @since 2024-12-01
 */
```

#### 3.3.2 类和函数注释

```typescript
/**
 * 前端代码分析器
 * 负责分析前端项目的代码结构、变量、函数和组件
 */
class FrontendCodeAnalyzer {
  /**
   * 分析整个项目
   * @param projectPath 项目路径
   * @returns 项目分析结果
   * @throws {Error} 当项目路径无效时抛出错误
   */
  async analyzeProject(projectPath: string): Promise<ProjectInfo> {
    // 实现
  }
}
```

#### 3.3.3 行内注释

```typescript
// 检测框架类型
this.detectFramework();

// 分析项目依赖
await this.analyzeDependencies();

// 扫描和分析所有源代码文件
await this.analyzeFiles();
```

## 4. 项目结构

### 4.1 目录结构

```
frontend-analysis-mcp/
├── src/                          # 源代码目录
│   ├── analyzer/                 # 代码分析器
│   │   ├── FrontendCodeAnalyzer.ts
│   │   ├── VariableTracker.ts
│   │   ├── FunctionAnalyzer.ts
│   │   └── ComponentAnalyzer.ts
│   ├── server/                   # MCP服务器
│   │   ├── MCPServer.ts
│   │   ├── ToolHandler.ts
│   │   └── ResourceHandler.ts
│   ├── types/                    # 类型定义
│   │   ├── index.ts
│   │   ├── ProjectInfo.ts
│   │   ├── VariableInfo.ts
│   │   └── ComponentInfo.ts
│   ├── utils/                    # 工具函数
│   │   ├── fileUtils.ts
│   │   ├── astUtils.ts
│   │   └── typeUtils.ts
│   └── index.ts                  # 入口文件
├── tests/                        # 测试目录
│   ├── unit/                     # 单元测试
│   │   ├── analyzer/
│   │   ├── server/
│   │   └── utils/
│   ├── integration/              # 集成测试
│   └── fixtures/                 # 测试数据
├── docs/                         # 文档目录
├── examples/                     # 示例目录
├── scripts/                      # 脚本目录
├── .github/                      # GitHub配置
├── .vscode/                      # VS Code配置
├── package.json
├── tsconfig.json
├── jest.config.js
├── .eslintrc.js
├── .prettierrc
└── README.md
```

### 4.2 模块组织

#### 4.2.1 分析器模块

```typescript
// src/analyzer/index.ts
export { FrontendCodeAnalyzer } from './FrontendCodeAnalyzer';
export { VariableTracker } from './VariableTracker';
export { FunctionAnalyzer } from './FunctionAnalyzer';
export { ComponentAnalyzer } from './ComponentAnalyzer';

// src/analyzer/FrontendCodeAnalyzer.ts
import { VariableTracker } from './VariableTracker';
import { FunctionAnalyzer } from './FunctionAnalyzer';
import { ComponentAnalyzer } from './ComponentAnalyzer';

export class FrontendCodeAnalyzer {
  private variableTracker: VariableTracker;
  private functionAnalyzer: FunctionAnalyzer;
  private componentAnalyzer: ComponentAnalyzer;

  constructor(projectPath: string) {
    this.variableTracker = new VariableTracker();
    this.functionAnalyzer = new FunctionAnalyzer();
    this.componentAnalyzer = new ComponentAnalyzer();
  }
}
```

#### 4.2.2 类型模块

```typescript
// src/types/index.ts
export * from './ProjectInfo';
export * from './VariableInfo';
export * from './FunctionInfo';
export * from './ComponentInfo';

// src/types/ProjectInfo.ts
export interface ProjectInfo {
  name: string;
  framework: string;
  files: FileInfo[];
  dependencies: DependencyInfo[];
}
```

## 5. 测试策略

### 5.1 测试框架配置

```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],
  collectCoverageFrom: ['src/**/*.ts', '!src/**/*.d.ts', '!src/index.ts'],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
```

### 5.2 单元测试

```typescript
// tests/unit/analyzer/FrontendCodeAnalyzer.test.ts
import { FrontendCodeAnalyzer } from '../../../src/analyzer/FrontendCodeAnalyzer';

describe('FrontendCodeAnalyzer', () => {
  let analyzer: FrontendCodeAnalyzer;

  beforeEach(() => {
    analyzer = new FrontendCodeAnalyzer('/test/project');
  });

  describe('analyzeProject', () => {
    it('should analyze a React project correctly', async () => {
      const result = await analyzer.analyzeProject();

      expect(result).toBeDefined();
      expect(result.framework).toBe('react');
      expect(result.files).toHaveLength(3);
    });

    it('should throw error for invalid project path', async () => {
      const invalidAnalyzer = new FrontendCodeAnalyzer('/invalid/path');

      await expect(invalidAnalyzer.analyzeProject()).rejects.toThrow();
    });
  });
});
```

### 5.3 集成测试

```typescript
// tests/integration/mcp-server.test.ts
import { FrontendAnalysisMCPServer } from '../../src/server/MCPServer';

describe('MCP Server Integration', () => {
  let server: FrontendAnalysisMCPServer;

  beforeAll(async () => {
    server = new FrontendAnalysisMCPServer();
    await server.start();
  });

  afterAll(async () => {
    await server.stop();
  });

  it('should handle analyze_project tool call', async () => {
    const request = {
      jsonrpc: '2.0',
      id: 1,
      method: 'tools/call',
      params: {
        name: 'analyze_project',
        arguments: {
          projectPath: '/test/project',
          framework: 'react',
        },
      },
    };

    const response = await server.handleRequest(request);

    expect(response.result).toBeDefined();
    expect(response.result.content).toHaveLength(1);
  });
});
```

### 5.4 测试数据

```typescript
// tests/fixtures/react-project/App.jsx
import React, { useState } from 'react';

function App() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    setCount(count + 1);
  };

  return (
    <div>
      <h1>Count: {count}</h1>
      <button onClick={handleClick}>Increment</button>
    </div>
  );
}

export default App;
```

## 6. 错误处理

### 6.1 错误类型定义

```typescript
// src/types/errors.ts
export class AnalysisError extends Error {
  constructor(
    message: string,
    public code: string,
    public context?: any
  ) {
    super(message);
    this.name = 'AnalysisError';
  }
}

export class ParseError extends AnalysisError {
  constructor(message: string, context?: any) {
    super(message, 'PARSE_ERROR', context);
  }
}

export class ValidationError extends AnalysisError {
  constructor(message: string, context?: any) {
    super(message, 'VALIDATION_ERROR', context);
  }
}
```

### 6.2 错误处理策略

```typescript
// src/utils/errorHandler.ts
export class ErrorHandler {
  static handleAnalysisError(error: Error): string {
    if (error instanceof ParseError) {
      return `解析错误: ${error.message}`;
    }

    if (error instanceof ValidationError) {
      return `验证错误: ${error.message}`;
    }

    return `未知错误: ${error.message}`;
  }

  static logError(error: Error, context?: any): void {
    console.error('Error occurred:', {
      message: error.message,
      stack: error.stack,
      context,
    });
  }
}
```

## 7. 性能优化

### 7.1 内存优化

```typescript
// 使用WeakMap缓存大对象
class AnalysisCache {
  private cache = new WeakMap<object, any>();

  get(key: object): any {
    return this.cache.get(key);
  }

  set(key: object, value: any): void {
    this.cache.set(key, value);
  }
}

// 及时释放不需要的对象
class FrontendCodeAnalyzer {
  private tempObjects: any[] = [];

  private cleanup(): void {
    this.tempObjects = [];
  }

  async analyzeProject(): Promise<ProjectInfo> {
    try {
      // 分析逻辑
      return result;
    } finally {
      this.cleanup();
    }
  }
}
```

### 7.2 性能监控

```typescript
// src/utils/performance.ts
export class PerformanceMonitor {
  private timers = new Map<string, number>();

  startTimer(name: string): void {
    this.timers.set(name, Date.now());
  }

  endTimer(name: string): number {
    const startTime = this.timers.get(name);
    if (startTime) {
      const duration = Date.now() - startTime;
      this.timers.delete(name);
      return duration;
    }
    return 0;
  }

  measure<T>(name: string, fn: () => T): T {
    this.startTimer(name);
    try {
      return fn();
    } finally {
      const duration = this.endTimer(name);
      console.log(`${name} took ${duration}ms`);
    }
  }
}
```

## 8. 部署流程

### 8.1 构建流程

```bash
# 1. 代码检查
npm run lint
npm run type-check

# 2. 运行测试
npm run test
npm run test:coverage

# 3. 构建项目
npm run build

# 4. 验证构建结果
node dist/mcp-server-example.js --version
```

### 8.2 Docker部署

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制package文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制构建后的代码
COPY dist/ ./dist/

# 设置启动命令
CMD ["node", "dist/mcp-server-example.js"]
```

### 8.3 CI/CD配置

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run type-check

      - name: Run tests
        run: npm run test:coverage

      - name: Build project
        run: npm run build

      - name: Upload coverage
        uses: codecov/codecov-action@v1
```

## 9. 调试技巧

### 9.1 VS Code调试配置

```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug MCP Server",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/src/index.ts",
      "outFiles": ["${workspaceFolder}/dist/**/*.js"],
      "env": {
        "NODE_ENV": "development"
      },
      "console": "integratedTerminal"
    }
  ]
}
```

### 9.2 日志配置

```typescript
// src/utils/logger.ts
export class Logger {
  private static instance: Logger;
  private level: 'debug' | 'info' | 'warn' | 'error';

  constructor(level: string = 'info') {
    this.level = level as any;
  }

  debug(message: string, ...args: any[]): void {
    if (this.shouldLog('debug')) {
      console.debug(`[DEBUG] ${message}`, ...args);
    }
  }

  info(message: string, ...args: any[]): void {
    if (this.shouldLog('info')) {
      console.info(`[INFO] ${message}`, ...args);
    }
  }

  private shouldLog(level: string): boolean {
    const levels = ['debug', 'info', 'warn', 'error'];
    return levels.indexOf(level) >= levels.indexOf(this.level);
  }
}
```

### 9.3 Debug文件管理

项目中的调试文件统一存放在 `debug/` 目录中，便于管理和维护：

```
debug/
├── debug_analyzeComponents.js      # 组件分析调试
├── debug_complexity.js             # 复杂度分析调试
├── debug_component_analyzer.js     # 组件分析器调试
├── debug_component_analyzer_simple.js
├── debug_component.js              # 组件调试
├── debug_components.js             # 多组件调试
├── debug_isReactComponent.js       # React组件检测调试
├── debug_loop_detailed.js          # 循环分析详细调试
├── debug_loop.js                   # 循环分析调试
├── debug_performance.js            # 性能分析调试
├── debug_scope.js                  # 作用域分析调试
├── debug_simple.js                 # 简单调试
└── debug_variable_tracker.js       # 变量跟踪调试
```

**使用说明：**

- 所有调试文件都以 `debug_` 前缀命名
- 调试文件不会被Git跟踪（已在.gitignore中配置）
- 创建新的调试文件时，请放在 `debug/` 目录中
- 调试文件主要用于开发和测试阶段的问题排查

**创建新的调试文件：**

```bash
# 在debug目录中创建新的调试文件
touch debug/debug_new_feature.js
```

## 10. 贡献指南

### 10.1 开发流程

1. **Fork项目**
2. **创建功能分支**: `git checkout -b feature/new-feature`
3. **编写代码**: 遵循代码规范
4. **编写测试**: 确保测试覆盖率
5. **提交代码**: `git commit -m "feat: add new feature"`
6. **推送分支**: `git push origin feature/new-feature`
7. **创建PR**: 描述变更内容

### 10.2 提交规范

```bash
# 提交类型
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建过程或辅助工具的变动

# 示例
git commit -m "feat: add Vue component analysis support"
git commit -m "fix: resolve memory leak in file analysis"
git commit -m "docs: update API documentation"
```

### 10.3 代码审查

- 确保代码符合项目规范
- 检查测试覆盖率
- 验证功能正确性
- 检查性能影响
- 确认文档更新

---

**文档版本**: v1.0  
**创建日期**: 2024年12月  
**最后更新**: 2024年12月  
**维护者**: AI助手
